if (typeof window === 'undefined') {
	console.log(`
                                                                                
                                                                                
	\x1b[48;2;255;255;255m      \x1b[0m                                                                
        \x1b[48;2;255;255;255m   \x1b[0m    \x1b[48;2;255;255;255m  \x1b[0m                      \x1b[48;2;255;255;255m \x1b[0m                                        
       \x1b[48;2;255;255;255m  \x1b[0m       \x1b[48;2;255;255;255m \x1b[0m                      \x1b[48;2;255;255;255m \x1b[0m                                        
       \x1b[48;2;255;255;255m \x1b[0m        \x1b[48;2;255;255;255m \x1b[0m                      \x1b[48;2;255;255;255m \x1b[0m                                        
       \x1b[48;2;255;255;255m \x1b[0m       \x1b[48;2;255;255;255m  \x1b[0m        \x1b[48;2;255;255;255m \x1b[0m             \x1b[48;2;255;255;255m \x1b[0m                                        
       \x1b[48;2;255;255;255m \x1b[0m      \x1b[48;2;255;255;255m  \x1b[0m                       \x1b[48;2;255;255;255m \x1b[0m              \x1b[48;2;128;0;0m      \x1b[0m                    
       \x1b[48;2;255;255;255m        \x1b[0m                       \x1b[48;2;255;255;255m      \x1b[0m         \x1b[48;2;128;0;0m    \x1b[48;2;91;0;0m  \x1b[48;2;128;0;0m  \x1b[0m                   
      \x1b[48;2;255;255;255m \x1b[0m           \x1b[48;2;255;255;255m \x1b[0m      \x1b[48;2;255;255;255m \x1b[0m            \x1b[48;2;255;255;255m \x1b[0m            \x1b[48;2;128;0;0m    \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m  \x1b[0m                   
      \x1b[48;2;255;255;255m  \x1b[0m       \x1b[48;2;255;255;255m      \x1b[0m    \x1b[48;2;255;255;255m  \x1b[0m     \x1b[48;2;255;255;255m    \x1b[0m  \x1b[48;2;255;255;255m \x1b[0m          \x1b[48;2;128;0;0m     \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m  \x1b[0m                    
       \x1b[48;2;255;255;255m \x1b[0m      \x1b[48;2;255;255;255m  \x1b[0m    \x1b[48;2;255;255;255m \x1b[0m    \x1b[48;2;255;255;255m  \x1b[0m    \x1b[48;2;255;255;255m  \x1b[0m  \x1b[48;2;255;255;255m  \x1b[0m \x1b[48;2;255;255;255m \x1b[0m         \x1b[48;2;128;0;0m    \x1b[48;2;91;0;0m     \x1b[48;2;128;0;0m  \x1b[0m                     
       \x1b[48;2;255;255;255m \x1b[0m      \x1b[48;2;255;255;255m \x1b[0m    \x1b[48;2;255;255;255m   \x1b[0m    \x1b[48;2;255;255;255m  \x1b[0m   \x1b[48;2;255;255;255m \x1b[0m    \x1b[48;2;255;255;255m \x1b[0m \x1b[48;2;255;255;255m  \x1b[0m       \x1b[48;2;128;0;0m    \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m  \x1b[0m                       
       \x1b[48;2;255;255;255m \x1b[0m       \x1b[48;2;255;255;255m     \x1b[0m \x1b[48;2;255;255;255m   \x1b[0m   \x1b[48;2;255;255;255m  \x1b[0m  \x1b[48;2;255;255;255m \x1b[0m    \x1b[48;2;255;255;255m \x1b[0m  \x1b[48;2;255;255;255m    \x1b[0m   \x1b[48;2;128;0;0m    \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m \x1b[0m                         
                                            \x1b[48;2;128;0;0m     \x1b[48;2;91;0;0m   \x1b[48;2;128;0;0m  \x1b[0m                          
                                           \x1b[48;2;128;0;0m    \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m  \x1b[0m                           
                                         \x1b[48;2;128;0;0m     \x1b[48;2;91;0;0m   \x1b[48;2;128;0;0m  \x1b[0m                             
                                        \x1b[48;2;128;0;0m     \x1b[48;2;91;0;0m   \x1b[48;2;128;0;0m  \x1b[0m                              
                                       \x1b[48;2;128;0;0m     \x1b[48;2;91;0;0m   \x1b[48;2;128;0;0m  \x1b[0m                               
                                     \x1b[48;2;128;0;0m     \x1b[48;2;91;0;0m   \x1b[48;2;128;0;0m  \x1b[0m                                 
                                   \x1b[48;2;128;0;0m     \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m \x1b[0m                                   
                                  \x1b[48;2;128;0;0m     \x1b[48;2;91;0;0m   \x1b[48;2;128;0;0m  \x1b[0m                                    
                                 \x1b[48;2;128;0;0m    \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m  \x1b[0m                                     
                                \x1b[48;2;128;0;0m   \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m  \x1b[0m                                       
                              \x1b[48;2;128;0;0m    \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m  \x1b[0m                                        
                             \x1b[48;2;128;0;0m   \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m  \x1b[0m                                          
                           \x1b[48;2;128;0;0m   \x1b[48;2;91;0;0m     \x1b[48;2;128;0;0m  \x1b[0m                                           
                         \x1b[48;2;128;0;0m    \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m   \x1b[0m                                            
                        \x1b[48;2;128;0;0m    \x1b[48;2;91;0;0m    \x1b[48;2;128;0;0m  \x1b[0m                                              
                     \x1b[48;2;128;0;0m     \x1b[48;2;91;0;0m     \x1b[48;2;128;0;0m  \x1b[0m                                               
                   \x1b[48;2;128;0;0m     \x1b[48;2;91;0;0m      \x1b[48;2;128;0;0m \x1b[0m                                                 
              \x1b[48;2;255;0;255m      \x1b[48;2;240;2;240m \x1b[48;2;128;0;0m  \x1b[48;2;91;0;0m     \x1b[48;2;128;0;0m  \x1b[0m                                                  
            \x1b[48;2;255;0;255m       \x1b[48;2;240;2;240m \x1b[48;2;233;0;233m \x1b[48;2;240;2;240m \x1b[48;2;128;0;0m  \x1b[48;2;91;0;0m  \x1b[48;2;128;0;0m  \x1b[0m                                                    
          \x1b[48;2;255;0;255m        \x1b[48;2;240;2;240m \x1b[48;2;233;0;233m   \x1b[48;2;174;3;174m \x1b[48;2;128;0;0m  \x1b[0m                                                       
         \x1b[48;2;255;0;255m        \x1b[48;2;240;2;240m \x1b[48;2;233;0;233m   \x1b[48;2;174;3;174m  \x1b[0m                                                         
        \x1b[48;2;255;0;255m        \x1b[48;2;240;2;240m \x1b[48;2;233;0;233m   \x1b[48;2;174;3;174m  \x1b[0m                                                          
        \x1b[48;2;255;0;255m      \x1b[48;2;240;2;240m   \x1b[48;2;233;0;233m  \x1b[48;2;174;3;174m  \x1b[0m                                                           
       \x1b[48;2;255;0;255m   \x1b[48;2;240;2;240m     \x1b[48;2;233;0;233m  \x1b[48;2;174;3;174m   \x1b[0m                                                            
      \x1b[48;2;240;2;240m      \x1b[48;2;233;0;233m  \x1b[48;2;174;3;174m    \x1b[0m                                                              
      \x1b[48;2;174;3;174m         \x1b[0m                                                                 
     \x1b[48;2;174;3;174m      \x1b[0m                                                                     
                                                                                
                                                                                
                                                                                
`)
	console.error('What are you doing? This isn\'t a Node.js file');
	process.exit(1);
}

// Height of each character block
const width = 1;
const height = 1;

// The scale factor from the size of the canvas to the appeared size of the canvas
const scaleX = 8;
const scaleY = 16;

let previous = null;

let painting = false;

function save() {
    const download = document.getElementById('download');
    const canvas = document.getElementById('paint');

    const data = canvas.toDataURL('image/png').replace(/^data:image\/[^;]/, 'data:application/octet-stream');
    download.setAttribute('href', data);
}

function setColour(r, g, b) {
	const colour = document.getElementById('colour');
	const rgb = [r, g, b].map(colour => colour.toString(16)).map((colour) => {
		for (i = 0; i < (2 - colour.length); i += 1) {
			colour += '0'
		}
		return colour;
	}).join('');

	colour.value = `#${rgb}`;
};

const paint = document.getElementById('paint');
const colour = document.getElementById('colour');
const rubber = document.getElementById('rubber');
const output = document.getElementById('output');
const canvas = paint.getContext('2d');
const area = paint.getBoundingClientRect();

const generate = () => {
	let i = 0;
	let j = 0;
	let beforeColour = 'transparent';
	let outString = '';

	for (j = 0; j < paint.height; j += height) {
		for (i = 0; i < paint.width; i += width) {
			const data = canvas.getImageData(i, j, 1, 1).data;
			let currentColour;
			let outColour;
			if (data[3]) {
				currentColour = `rgb(${data[0]}, ${data[1]}, ${data[2]})`;
				outColour = `\\x1b[48;2;${data[0]};${data[1]};${data[2]}m`;
			} else {
				currentColour = 'transparent';
				outColour = '\\x1b[0m';
			}

			if (beforeColour !== currentColour) {
				beforeColour = currentColour;
				outString += outColour;
			}
			outString += ' ';
		}
		outString += '\n';
	}
	output.value = outString;
}

const down = (point) => {
	const realX = point.x * width;
	const realY = point.y * height;

	if (rubber.checked) {
		canvas.clearRect(realX, realY, width, height);
	} else {
		canvas.fillRect(realX, realY, width, height);
	}
};

// https://stackoverflow.com/questions/4672279/bresenham-algorithm-in-javascript
const line = (previous, current) => {
	const coordinates = [];
	let x1 = previous.x;
	let y1 = previous.y;
	let x2 = current.x;
	let y2 = current.y;

	const dx = Math.abs(x2 - x1);
	const dy = Math.abs(y2 - y1);
	const sx = (x1 < x2) ? 1 : -1;
	const sy = (y1 < y2) ? 1 : -1;
	let err = dx - dy;

	coordinates.push(previous);

	while(!((x1 === x2) && (y1 === y2))) {
		const e2 = err << 1;
		if (e2 > -dy) {
			err -= dy;
			x1 += sx;
		}
		if (e2 < dx) {
			err += dx;
			y1 += sy;
		}
		coordinates.push({
			x: x1,
			y: y1
		})
	}
	coordinates.forEach((point) => {
		down(point);
	})
};

paint.addEventListener('mousedown', (e) => {
	const x = Math.floor((e.pageX - paint.offsetLeft) / scaleX);
	const y = Math.floor((e.pageY - paint.offsetTop) / scaleY);
	canvas.fillStyle = colour.value;
	down({
		x, y
	});
	
	painting = true;
});

paint.addEventListener('mousemove', (e) => {
	const x = Math.floor((e.pageX - paint.offsetLeft) / scaleX);
	const y = Math.floor((e.pageY - paint.offsetTop) / scaleY);
	console.log(x, y);
	if (painting) {
		down({
			x, y
		});
		if (previous && previous.x !== x && previous.y !== y) {
			line(previous, {
				x, y
			});
		}
		previous = {
			x, y
		}
	}
})

paint.addEventListener('mouseup', () => {
	painting = false;
	previous = null;
});

paint.addEventListener('mouseout', () => {
	painting = false;
	previous = null;
});

